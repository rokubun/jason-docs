# Jason's Application Programming Interface

For workflows that require to process several GNSS files in a batch, Jason
provides an Application Programming Interface (API) that allows to automate
the complete processing.

Under the hood, Jason is an API that can be used via the front-end, as you may
be using it now, or directly using URLs via your Operating System command line.
This latter approach allows to automate processes or create plugins for your
photogrammetry processing software, for example.

## Launching a process

Let' assume you have a GNSS data file in RINEX format named `GARR2150.15o` that
you wish to process. Let's also assume you have your API key and secret token
ready ([fetch them in your user section](../user#how-to-obtain-your-api-key)):

```bash
export APIKEY="jason_api_key_here"
export SECRET_TOKEN="your_secret_token_here"
```

With this information you can fire a process with a `curl` command, like so:

```bash
curl -X POST  -H "accept: application/json" \
                       -H "Content-Type: multipart/form-data" \
                       -H "ApiKey: ${APIKEY}"  \
                       -F  token=${SECRET_TOKEN} -F type=GNSS  \
                       -F "rover_file=@GARR2150.15o"  \
                                "http://api-argonaut.rokubun.cat/api/processes/"
```

Now the process is being run in Rokubun's servers. The previous command replies
with a small JSON formatted string with the status of the command (success
indicates that the process has been correctly launched) and the process id that
has been assigned (in this example the process id is 707):

```json
{"message":"success","id":707} 
```

You can check the status of the process at any time under the tab **My processes**
in your user area of the front-end or, alternatively with this curl command
(that will answer with a JSON string):

```bash
curl -X GET -H "ApiKey: ${APIKEY}" \
                     -H "accept: application/json"  \
                     "http://api-argonaut.rokubun.cat/api/processes/707?token=${SECRET_TOKEN}"
```

The JSON string will give details on the run as well as any log messages that
describe what is being done with the file (PPK, PPP, SPP, ... depending on the
data availability). A sample is shown below:

```json
{
  "process": {
    "id": 707,
    "user_id": 24,
    "type": "GNSS",
    "status": "RUNNING",
    "source_file": "https://argonaut-files.s3.eu-central-1.amazonaws.com/source_files/258ab2a88691ad7cb47d91a832e13aa8/GARR2150.15o",
    "source_base_file": null,
    "camera_metadata_file": null,
    "created": "2018-02-07 14:33:38",
    "finished": null
  },
  "log": [
    {
      "id": 1630,
      "process_id": 707,
      "level": "INFO",
      "message": "[GARR2150.15o] file successfully loaded\n",
      "created": "2018-02-07 14:33:42"
    },
    {
      "id": 1631,
      "process_id": 707,
      "level": "INFO",
      "message": "[Broadcast] orbits successfully downloaded\n",
      "created": "2018-02-07 14:33:45"
    },
    ...  
```

## Downloading the results file

Once the status of the process is finished (`"status": "FINISHED"`, under
`"process"`), the JSON response generated by the previous command will contain,
at the end, the link to the zipped result file with figures, Google Earth's KML
file, text file with positions, etcetera:

```json
    ...
        {
      "id": 2043,
      "process_id": 707,
      "url": "https://argonaut-files.s3.eu-central-1.amazonaws.com/results/1589edb715ebbe117bbdefe5e44192e2/results.zip",
      "created": "2018-02-07 14:34:28",
      "name": "results.zip",
      "extension": "zip"
    }
  ]
}
```

You can download the results file via the browser or, if you want to automate 
the process, use Bash scripting, like so:

```bash
wget `json2yaml response.json  | awk '/url/&&/results.zip/{print $2}'`
```

(note that you will need the tool [json2yaml](https://www.npmjs.com/package/json2yaml)
for that to work)

You can also use Python to automate this and download the results file (`results.zip`):

```python
import json
import urllib.request

with open("response.json") as fp:
   res = json.load(fp)

url = res["results"][-1]["url"]
urllib.request.urlretrieve(url)
```

The zip file contains a Google Earth's KML file, the results file and different
figures with the quality metrics. You have a description of each file in the
README file included in the ZIP file.
